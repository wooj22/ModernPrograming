BMI 생성 순서

BMI 생성 순서(Binary Module Interface build order)는
C++ Module을 이해했는지를 가르는 진짜 심화 포인트입니다.
여기서부터는 문법이 아니라 컴파일러 + 빌드 시스템의 역할 분담 영역입니다.

1. BMI란 무엇인가 (짧게 정리)

BMI (Binary Module Interface)
→ 모듈 인터페이스 유닛을 컴파일해서 생성되는 컴파일러 전용 바이너리 산출물

	헤더의 .h에 해당하는 개념
	사람이 읽는 파일 ❌
	컴파일러 종속 ❌ → 컴파일러 종속 ⭕

2. 왜 “순서”가 문제가 되는가?

헤더:

#include "a.h"
#include "b.h"

→ 텍스트이므로 순서가 중요하지만 빌드 순서는 아님

Module:

import a;
import b;

👉 a, b의 BMI가 이미 존재해야 컴파일 가능

즉,

모듈은 컴파일 전에 의존성 그래프가 완성되어야 한다.


3.  기본적인 BMI 생성 단계

단계 흐름

[Module Interface (.ixx)]
        ↓
[컴파일]
        ↓
[BMI 생성]
        ↓
[Object 파일 생성]

중요한 점
	BMI는 오브젝트보다 먼저 필요
	BMI 없으면 import 불가

4. 의존성 있는 모듈들의 실제 순서 예제

코드 구조

	// math.ixx
	export module math;
	export int add(int, int);

	// util.ixx
	export module util;
	import math;
	export int twice(int);

빌드 순서

	1. math.ixx → math.bmi
	2. util.ixx → util.bmi
	3. main.cpp → object

	👉 import 그래프의 위상 정렬 결과가 빌드 순서


5.  사이클이 생기면?

	// A imports B
	// B imports A

	❌ 불가능

	해결 방법

		공통 부분을 별도 모듈로 분리	
		인터페이스 의존 최소화
		구현 유닛에서만 import 사용


6. Interface / Implementation 분리 시 순서

	// m.ixx
	export module m;
	export void f();

	// m.cpp
	module m;
	void f() {}

	순서
		1. m.ixx → BMI 생성
		2. m.cpp → BMI 참조 → object

	✔ 구현 유닛은 BMI를 생성하지 않음
	✔ BMI는 인터페이스 유닛 전용


7. Global Module Fragment가 끼어들면?

	module;
	#include <windows.h>
	
	export module win;

	영향
		전처리 단계가 BMI 생성 전에 실행
		매크로/헤더 내용이 BMI에 반영됨
		BMI 캐시 무효화 가능성 증가

	👉 GMF는 필요한 곳에만 최소 사용


8. std 모듈과 BMI

	import std;

	표준 라이브러리도 BMI 필요
	대부분 컴파일러 설치 시 사전 생성
	사용자 빌드 단계에서 직접 생성 ❌

9. 빌드 시스템이 어려워지는 진짜 이유

헤더 시대
	컴파일러가 알아서 처리
	빌드 시스템은 파일 목록만 관리

모듈 시대

	빌드 시스템이 해야 할 일:
		모듈 스캔
		의존성 그래프 생성
		BMI 선행 빌드
		캐시 관리
	👉 빌드 시스템이 컴파일러의 일부 역할을 떠안음

10. 면접에서 나오는 핵심 질문들

	Q. “BMI는 언제 생성되나요?”

	“모듈 인터페이스 유닛 컴파일 시, 오브젝트 파일과 함께 또는 그 이전에 생성됩니다.”

	Q. “왜 병렬 빌드가 어려워지나요?”

	“BMI 생성 순서가 의존성 그래프를 강제하기 때문입니다.”

	Q. “BMI는 ABI와 관계가 있나요?”

	“직접적인 ABI는 아니지만, 인터페이스 고정으로 ABI 관리가 쉬워집니다.”

11. 실무 조언 (중요)

	모듈 수를 과도하게 쪼개지 말 것
	인터페이스는 얇게
	구현 의존은 implementation unit으로 밀기
	BMI 캐시 무효화 원인을 줄이기

한 문장 요약 (면접용)

	“Module은 소스가 아니라 ‘의존성 그래프’를 먼저 컴파일한다.”








